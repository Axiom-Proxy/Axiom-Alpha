<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, shrink-to-fit=no">
  <title>Axiom AI</title>
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght@250" rel="stylesheet">
  <style>
/* ✨ ULTRA MODERN AI CHAT INTERFACE ✨ */

:root {
  /* Modern Color Palette */
  --color-primary: #6366f1;
  --color-secondary: #8b5cf6;
  --color-accent: #06b6d4;
  --color-success: #10b981;
  --color-warning: #f59e0b;
  --color-danger: #ef4444;
  
  /* Background & Surfaces */
  --color-background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #334155 100%);
  --color-surface: rgba(255, 255, 255, 0.08);
  --color-surface-hover: rgba(255, 255, 255, 0.12);
  --color-surface-active: rgba(255, 255, 255, 0.16);
  
  /* Text Colors */
  --color-text-primary: #f8fafc;
  --color-text-secondary: #cbd5e1;
  --color-text-muted: #94a3b8;
  
  /* Glassmorphism Effects */
  --glass-background: rgba(255, 255, 255, 0.1);
  --glass-border: rgba(255, 255, 255, 0.2);
  --glass-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
  --glass-blur: blur(16px);
  
  /* Chat Specific Colors */
  --user-message-bg: rgba(99, 102, 241, 0.2);
  --user-message-border: rgba(99, 102, 241, 0.4);
  --ai-message-bg: rgba(16, 185, 129, 0.2);
  --ai-message-border: rgba(16, 185, 129, 0.4);
  --context-message-bg: rgba(245, 158, 11, 0.2);
  --context-message-border: rgba(245, 158, 11, 0.4);
  --thinking-message-bg: rgba(139, 92, 246, 0.15);
  --thinking-message-border: rgba(139, 92, 246, 0.3);
  
  /* Spacing & Dimensions */
  --header-height: 60px;
  --input-height: 70px;
  --border-radius: 12px;
  --border-radius-lg: 16px;
  --border-radius-xl: 20px;
  --spacing-xs: 4px;
  --spacing-sm: 6px;
  --spacing-md: 12px;
  --spacing-lg: 16px;
  --spacing-xl: 24px;
  
  /* Transitions */
  --transition-fast: 0.15s cubic-bezier(0.4, 0, 0.2, 1);
  --transition-normal: 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  --transition-slow: 0.5s cubic-bezier(0.4, 0, 0.2, 1);
}

* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

body {
  background: var(--color-background);
  color: var(--color-text-primary);
  font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  height: 100vh;
  overflow: hidden;
  position: relative;
}

/* Animated Background */
body::before {
  content: '';
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: 
    radial-gradient(circle at 20% 50%, rgba(120, 119, 198, 0.3) 0%, transparent 50%),
    radial-gradient(circle at 80% 20%, rgba(255, 119, 198, 0.3) 0%, transparent 50%),
    radial-gradient(circle at 40% 80%, rgba(120, 219, 255, 0.3) 0%, transparent 50%);
  z-index: -1;
  animation: backgroundShift 20s ease-in-out infinite;
}

@keyframes backgroundShift {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.7; }
}

/* Header */
.header {
  background: var(--glass-background);
  backdrop-filter: var(--glass-blur);
  border-bottom: 1px solid var(--glass-border);
  width: 100%;
  height: var(--header-height);
  position: fixed;
  top: 0;
  z-index: 1000;
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 0 var(--spacing-xl);
  box-shadow: var(--glass-shadow);
}

.logo {
  display: flex;
  align-items: center;
  gap: var(--spacing-sm);
  color: var(--color-primary);
  font-size: 24px;
  font-weight: 700;
}

.header-actions {
  display: flex;
  align-items: center;
  gap: var(--spacing-sm);
}

.action-btn {
  background: var(--glass-background);
  border: 1px solid var(--glass-border);
  border-radius: var(--border-radius);
  color: var(--color-text-secondary);
  cursor: pointer;
  padding: var(--spacing-sm);
  transition: all var(--transition-fast);
  backdrop-filter: var(--glass-blur);
  display: flex;
  align-items: center;
  justify-content: center;
  width: 40px;
  height: 40px;
  font-size: 18px;
}

.action-btn:hover {
  background: var(--color-surface-hover);
  border-color: var(--color-primary);
  color: var(--color-text-primary);
  transform: translateY(-1px);
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
}

.action-btn.clear:hover {
  border-color: var(--color-warning);
  color: var(--color-warning);
}

.action-btn.context:hover {
  border-color: var(--color-accent);
  color: var(--color-accent);
}

.action-btn.deepthink:hover {
  border-color: var(--color-secondary);
  color: var(--color-secondary);
}

.action-btn.active {
  background: var(--color-secondary);
  border-color: var(--color-secondary);
  color: white;
}

.action-btn.context.active {
  background: var(--color-accent);
  border-color: var(--color-accent);
}

/* Chat Container */
.chat-container {
  height: 100vh;
  display: flex;
  flex-direction: column;
  padding-top: var(--header-height);
}

.chat-messages {
  flex: 1;
  overflow-y: auto;
  padding: var(--spacing-xl);
  display: flex;
  flex-direction: column;
  gap: var(--spacing-lg);
  scroll-behavior: smooth;
}

/* Welcome Message */
.welcome-message {
  text-align: center;
  padding: var(--spacing-xl);
  color: var(--color-text-muted);
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: var(--spacing-lg);
  margin: auto 0;
}

.welcome-message .ai-icon {
  font-size: 64px;
  background: linear-gradient(135deg, var(--color-primary), var(--color-accent));
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
  animation: pulse 2s ease-in-out infinite;
}

@keyframes pulse {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.7; }
}

.welcome-title {
  font-size: 28px;
  font-weight: 700;
  color: var(--color-text-primary);
  margin-bottom: var(--spacing-sm);
}

.welcome-subtitle {
  font-size: 16px;
  line-height: 1.6;
  max-width: 500px;
}

.suggested-prompts {
  display: flex;
  flex-wrap: wrap;
  gap: var(--spacing-sm);
  justify-content: center;
  margin-top: var(--spacing-lg);
}

.prompt-suggestion {
  background: var(--glass-background);
  border: 1px solid var(--glass-border);
  border-radius: var(--border-radius-lg);
  padding: var(--spacing-sm) var(--spacing-md);
  color: var(--color-text-secondary);
  cursor: pointer;
  transition: all var(--transition-fast);
  font-size: 14px;
  backdrop-filter: var(--glass-blur);
}

.prompt-suggestion:hover {
  background: var(--color-surface-hover);
  border-color: var(--color-primary);
  color: var(--color-text-primary);
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
}

/* Context Status */
.context-status {
  background: var(--context-message-bg);
  border: 1px solid var(--context-message-border);
  border-radius: var(--border-radius);
  padding: var(--spacing-sm) var(--spacing-md);
  margin-bottom: var(--spacing-md);
  font-size: 14px;
  color: var(--color-warning);
  display: none;
  align-items: center;
  gap: var(--spacing-sm);
}

.context-status.active {
  display: flex;
}

/* Message Bubbles */
.message {
  display: flex;
  gap: var(--spacing-md);
  max-width: 85%;
  animation: messageSlideIn 0.3s ease-out;
}

@keyframes messageSlideIn {
  from {
    opacity: 0;
    transform: translateY(20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.message.user {
  align-self: flex-end;
  flex-direction: row-reverse;
}

.message.ai {
  align-self: flex-start;
}

.message.thinking {
  align-self: flex-start;
  max-width: 90%;
}

.message-avatar {
  width: 40px;
  height: 40px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 18px;
  flex-shrink: 0;
  backdrop-filter: var(--glass-blur);
}

.message.user .message-avatar {
  background: var(--user-message-bg);
  border: 1px solid var(--user-message-border);
  color: var(--color-primary);
}

.message.ai .message-avatar {
  background: var(--ai-message-bg);
  border: 1px solid var(--ai-message-border);
  color: var(--color-success);
}

.message.thinking .message-avatar {
  background: var(--thinking-message-bg);
  border: 1px solid var(--thinking-message-border);
  color: var(--color-secondary);
}

.message-bubble {
  background: var(--glass-background);
  backdrop-filter: var(--glass-blur);
  border-radius: var(--border-radius-lg);
  padding: var(--spacing-md) var(--spacing-lg);
  box-shadow: var(--glass-shadow);
  position: relative;
  max-width: 100%;
  word-wrap: break-word;
  line-height: 1.6;
}

.message.user .message-bubble {
  background: var(--user-message-bg);
  border: 1px solid var(--user-message-border);
  border-radius: var(--border-radius-lg) var(--border-radius-lg) var(--spacing-xs) var(--border-radius-lg);
}

.message.ai .message-bubble {
  background: var(--ai-message-bg);
  border: 1px solid var(--ai-message-border);
  border-radius: var(--border-radius-lg) var(--border-radius-lg) var(--border-radius-lg) var(--spacing-xs);
}

.message.thinking .message-bubble {
  background: var(--thinking-message-bg);
  border: 1px solid var(--thinking-message-border);
  border-radius: var(--border-radius-lg) var(--border-radius-lg) var(--border-radius-lg) var(--spacing-xs);
}

.thinking-header {
  display: flex;
  align-items: center;
  gap: var(--spacing-sm);
  margin-bottom: var(--spacing-md);
  color: var(--color-secondary);
  font-weight: 600;
  font-size: 14px;
}

.thinking-content {
  color: var(--color-text-secondary);
  font-style: italic;
  font-size: 14px;
  line-height: 1.5;
  border-left: 3px solid var(--color-secondary);
  padding-left: var(--spacing-md);
  margin-left: var(--spacing-sm);
}

.message-time {
  font-size: 11px;
  color: var(--color-text-muted);
  margin-top: var(--spacing-xs);
  opacity: 0.7;
}

.message.user .message-time {
  text-align: right;
}

/* Typing Indicator */
.typing-indicator {
  display: flex;
  align-items: center;
  gap: var(--spacing-sm);
  padding: var(--spacing-md);
  color: var(--color-text-muted);
  font-style: italic;
}

.typing-dots {
  display: flex;
  gap: var(--spacing-xs);
}

.typing-dot {
  width: 6px;
  height: 6px;
  background: var(--color-success);
  border-radius: 50%;
  animation: typingDot 1.5s ease-in-out infinite;
}

.typing-dot:nth-child(2) {
  animation-delay: 0.2s;
}

.typing-dot:nth-child(3) {
  animation-delay: 0.4s;
}

@keyframes typingDot {
  0%, 60%, 100% {
    opacity: 0.3;
    transform: scale(0.8);
  }
  30% {
    opacity: 1;
    transform: scale(1);
  }
}

/* Thinking Indicator */
.thinking-indicator {
  display: flex;
  align-items: center;
  gap: var(--spacing-sm);
  padding: var(--spacing-md);
  color: var(--color-secondary);
  font-style: italic;
}

.thinking-dots {
  display: flex;
  gap: var(--spacing-xs);
}

.thinking-dot {
  width: 6px;
  height: 6px;
  background: var(--color-secondary);
  border-radius: 50%;
  animation: thinkingDot 1.5s ease-in-out infinite;
}

.thinking-dot:nth-child(2) {
  animation-delay: 0.2s;
}

.thinking-dot:nth-child(3) {
  animation-delay: 0.4s;
}

@keyframes thinkingDot {
  0%, 60%, 100% {
    opacity: 0.3;
    transform: scale(0.8);
  }
  30% {
    opacity: 1;
    transform: scale(1);
  }
}

/* Input Section */
.input-section {
  background: var(--glass-background);
  backdrop-filter: var(--glass-blur);
  border-top: 1px solid var(--glass-border);
  padding: var(--spacing-lg) var(--spacing-xl);
  box-shadow: 0 -8px 32px rgba(0, 0, 0, 0.3);
}

.input-container {
  display: flex;
  gap: var(--spacing-md);
  align-items: flex-end;
  max-width: 1200px;
  margin: 0 auto;
}

#messageInput {
  flex: 1;
  background: var(--glass-background);
  border: 2px solid var(--glass-border);
  border-radius: var(--border-radius-lg);
  color: var(--color-text-primary);
  font-size: 16px;
  padding: var(--spacing-md) var(--spacing-lg);
  outline: none;
  backdrop-filter: var(--glass-blur);
  transition: all var(--transition-normal);
  font-family: inherit;
  resize: none;
  min-height: 50px;
  max-height: 120px;
  line-height: 1.5;
}

#messageInput::placeholder {
  color: var(--color-text-muted);
}

#messageInput:focus {
  border-color: var(--color-primary);
  background: var(--color-surface-hover);
  box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
  transform: scale(1.01);
}

.send-btn {
  background: var(--color-primary);
  border: none;
  border-radius: var(--border-radius-lg);
  color: white;
  cursor: pointer;
  padding: var(--spacing-md);
  transition: all var(--transition-fast);
  display: flex;
  align-items: center;
  justify-content: center;
  width: 50px;
  height: 50px;
  font-size: 20px;
  flex-shrink: 0;
}

.send-btn:hover:not(:disabled) {
  background: #5856eb;
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(99, 102, 241, 0.4);
}

.send-btn:active {
  transform: translateY(0);
}

.send-btn:disabled {
  background: var(--color-text-muted);
  cursor: not-allowed;
  opacity: 0.5;
}

/* Custom Scrollbar */
.chat-messages::-webkit-scrollbar {
  width: 6px;
}

.chat-messages::-webkit-scrollbar-track {
  background: rgba(255, 255, 255, 0.05);
  border-radius: 3px;
}

.chat-messages::-webkit-scrollbar-thumb {
  background: var(--color-primary);
  border-radius: 3px;
}

.chat-messages::-webkit-scrollbar-thumb:hover {
  background: var(--color-secondary);
}

/* Error States */
.error-message {
  background: rgba(239, 68, 68, 0.1);
  border: 1px solid rgba(239, 68, 68, 0.3);
  border-radius: var(--border-radius);
  padding: var(--spacing-md);
  color: var(--color-danger);
  font-size: 14px;
  display: flex;
  align-items: center;
  gap: var(--spacing-sm);
}

/* Loading Animation */
.loading-pulse {
  animation: loadingPulse 2s ease-in-out infinite;
}

@keyframes loadingPulse {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.6; }
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

/* Responsive Design */
@media (max-width: 768px) {
  .header {
    padding: 0 var(--spacing-md);
  }
  
  .logo {
    font-size: 20px;
  }
  
  .chat-messages {
    padding: var(--spacing-md);
  }
  
  .input-section {
    padding: var(--spacing-md);
  }
  
  .message {
    max-width: 95%;
  }
  
  .welcome-title {
    font-size: 24px;
  }
  
  .suggested-prompts {
    flex-direction: column;
    align-items: center;
  }
}

@media (max-width: 480px) {
  #messageInput {
    font-size: 14px;
  }
  
  .send-btn {
    width: 45px;
    height: 45px;
    font-size: 18px;
  }
  
  .message-avatar {
    width: 35px;
    height: 35px;
    font-size: 16px;
  }
}

/* Focus States for Accessibility */
.action-btn:focus,
.send-btn:focus,
#messageInput:focus,
.prompt-suggestion:focus {
  outline: 2px solid var(--color-primary);
  outline-offset: 2px;
}

/* Selection Styles */
::selection {
  background: rgba(99, 102, 241, 0.3);
  color: var(--color-text-primary);
}

/* Smooth Animations */
.message-bubble {
  transform-origin: bottom left; 
}

.message.user .message-bubble {
  transform-origin: bottom right;
}
  </style>
</head>
<body>
  <header class="header">
    <div class="logo">
      <span class="material-symbols-outlined">auto_awesome</span>
      <span>Axiom AI</span>
    </div>
    
    <div class="header-actions">
      <button class="action-btn context" id="contextBtn" onclick="toggleContextMode()" title="Toggle Context Mode">
        <span class="material-symbols-outlined">description</span>
      </button>
      <button class="action-btn deepthink" id="deepthinkBtn" onclick="toggleDeepThink()" title="Toggle Deep Thinking Mode">
        <span class="material-symbols-outlined">psychology</span>
      </button>
      <button class="action-btn clear" onclick="clearChat()" title="Clear Chat">
        <span class="material-symbols-outlined">delete_sweep</span>
      </button>
    </div>
  </header>

  <div class="chat-container">
    <div class="context-status" id="contextStatus">
      <span class="material-symbols-outlined">info</span>
      <span id="contextInfo">No webpage context loaded</span>
    </div>

    <div class="chat-messages" id="chatMessages">
      <div class="welcome-message" id="welcomeMessage">
        <div class="material-symbols-outlined ai-icon">auto_awesome</div>
        <div class="welcome-title">Welcome to Axiom AI</div>
        <div class="welcome-subtitle">
          Your intelligent conversation partner powered by advanced AI. I can help with questions, analysis, and even work with webpage content.
        </div>

      </div>
    </div>

    <div class="input-section">
      <div class="input-container">
        <textarea 
          id="messageInput" 
          placeholder="Type your message here... "
          rows="1"
        ></textarea>
        <button class="send-btn" id="sendBtn" onclick="sendMessage()">
          <span class="material-symbols-outlined">send</span>
        </button>
      </div>
    </div>
  </div>

  <script>
    const API_BASE_URL = 'https://charbot.ape3d.com?prompt=';
    let chatHistory = [];
    let isTyping = false;
    let contextMode = false;
    let deepthink = false;

    // Initialize
    document.addEventListener('DOMContentLoaded', function() {
      const messageInput = document.getElementById('messageInput');
      const sendBtn = document.getElementById('sendBtn');
      
      // Auto-resize textarea
      messageInput.addEventListener('input', function() {
        this.style.height = 'auto';
        this.style.height = Math.min(this.scrollHeight, 120) + 'px';
        
        // Enable/disable send button
        sendBtn.disabled = !this.value.trim();
      });
      
      // Handle Enter key
      messageInput.addEventListener('keydown', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          if (!isTyping && this.value.trim()) {
            sendMessage();
          }
        }
      });
      
      // Initial button state
      sendBtn.disabled = true;
      
      // Check for webpage context on load
      checkWebpageContext();
    });

    function sendSuggestedPrompt(prompt) {
      document.getElementById('messageInput').value = prompt;
      sendMessage();
    }

    function toggleContextMode() {
      contextMode = !contextMode;
      const contextBtn = document.getElementById('contextBtn');
      
      if (contextMode) {
        contextBtn.classList.add('active');
        contextBtn.title = 'Context Mode: ON - Click to disable';
      } else {
        contextBtn.classList.remove('active');
        contextBtn.title = 'Context Mode: OFF - Click to enable';
      }
      
      checkWebpageContext();
    }

    function toggleDeepThink() {
      deepthink = !deepthink;
      const deepthinkBtn = document.getElementById('deepthinkBtn');
      
      if (deepthink) {
        deepthinkBtn.classList.add('active');
        deepthinkBtn.title = 'Deep Thinking Mode: ON - Click to disable';
      } else {
        deepthinkBtn.classList.remove('active');
        deepthinkBtn.title = 'Deep Thinking Mode: OFF - Click to enable';
      }
    }

    function checkWebpageContext() {
      const contextStatus = document.getElementById('contextStatus');
      const contextInfo = document.getElementById('contextInfo');
      const webpageData = sessionStorage.getItem("HTML4AI");
      
      if (webpageData && contextMode) {
        const processedData = processWebpageData(webpageData);
        const contextLength = processedData.content.length;
        const processingMode = deepthink ? 'full chunked processing' : 'limited to 500 chars';
        contextStatus.classList.add('active');
        contextInfo.textContent = `Webpage context loaded: ${processedData.title || 'Unknown page'} (${processedData.wordCount} words, ${processingMode})`;
      }
    }

    function processWebpageData(htmlData) {
      // Create a temporary DOM element to parse HTML
      const tempDiv = document.createElement('div');
      tempDiv.innerHTML = htmlData;
      
      // Extract meaningful content
      const title = tempDiv.querySelector('title')?.textContent || 
                   tempDiv.querySelector('h1')?.textContent || 
                   'Unknown Page';
      
      // Remove script and style elements
      const scripts = tempDiv.querySelectorAll('script, style, noscript');
      scripts.forEach(element => element.remove());
      
      // Extract text content from various elements
      const contentSelectors = [
        'article', 'main', '.content', '#content',
        'p', 'h1', 'h2', 'h3', 'h4', 'h5', 'h6',
        'li', 'td', 'blockquote', '.text'
      ];
      
      let extractedText = '';
      let allText = tempDiv.textContent || tempDiv.innerText || '';
      
      // Clean up the text
      allText = allText
        .replace(/\s+/g, ' ') // Replace multiple whitespace with single space
        .replace(/\n\s*\n/g, '\n') // Remove empty lines
        .trim();
      
      // Try to extract more structured content
      contentSelectors.forEach(selector => {
        const elements = tempDiv.querySelectorAll(selector);
        elements.forEach(element => {
          const text = element.textContent?.trim();
          if (text && text.length > 20 && !extractedText.includes(text.substring(0, 50))) {
            extractedText += text + '\n\n';
          }
        });
      });
      
      // If structured extraction didn't work well, use the clean text
      if (extractedText.length < allText.length * 0.3) {
        extractedText = allText;
      }
      
      // Clean up final text
      extractedText = extractedText.trim();
      
      const wordCount = extractedText.split(/\s+/).length;
      
      return {
        title: title.substring(0, 100),
        content: extractedText,
        wordCount: wordCount,
        summary: extractedText
      };
    }

    function chunkText(text, chunkSize = 500) {
      const chunks = [];
      for (let i = 0; i < text.length; i += chunkSize) {
        // Try to break at word boundaries to avoid cutting words
        let chunk = text.substring(i, i + chunkSize);
        if (i + chunkSize < text.length && chunk[chunk.length - 1] !== ' ') {
          const lastSpaceIndex = chunk.lastIndexOf(' ');
          if (lastSpaceIndex > chunkSize * 0.7) { // Only break at space if it's not too far back
            chunk = chunk.substring(0, lastSpaceIndex);
          }
        }
        chunks.push(chunk.trim());
      }
      return chunks;
    }

    async function summarizeChunk(chunk, chunkIndex, totalChunks, title) {
      const prompt = `Please summarize the following content chunk from a webpage titled "${title}". This is chunk ${chunkIndex + 1} of ${totalChunks}. Extract the key information and main points:

Content:
${chunk}

Please provide a concise summary highlighting the most important information:`;

      try {
        const response = await fetch(`${API_BASE_URL}${encodeURIComponent(prompt)}`, {
          method: 'GET',
          headers: {
            'Accept': 'text/plain'
          }
        });
        
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        return await response.text();
      } catch (error) {
        console.error(`Error summarizing chunk ${chunkIndex + 1}:`, error);
        return `[Error summarizing chunk ${chunkIndex + 1}]`;
      }
    }

    function updateThinkingIndicator(message) {
      const thinkingIndicator = document.getElementById('thinkingIndicator');
      if (thinkingIndicator) {
        const messageSpan = thinkingIndicator.querySelector('.thinking-indicator span');
        if (messageSpan) {
          messageSpan.textContent = message;
        }
      }
    }

    async function sendMessage() {
      const messageInput = document.getElementById('messageInput');
      let message = messageInput.value.trim();
      if (!message || isTyping) return;

      // Clear input and hide welcome message
      messageInput.value = '';
      messageInput.style.height = 'auto';
      document.getElementById('sendBtn').disabled = true;
      hideWelcomeMessage();
      
      // Add user message
      addMessage(message, 'user');
      
      // Process webpage context if available and context mode is enabled
      let processedMessage = message;
      if (contextMode && sessionStorage.getItem("HTML4AI")) {
        const webpageData = processWebpageData(sessionStorage.getItem("HTML4AI"));
        
        const contextPrompt = `
<webpage_context>
Page Title: ${webpageData.title}
Content Summary: ${webpageData.summary}

Relevant Content:
${webpageData.content}
</webpage_context>

User Question: ${message}

Instructions: You have access to the above webpage content. Please answer the user's question using this context when relevant. If the question is not related to the webpage content, feel free to answer normally. When using information from the webpage, please indicate that you're referencing the provided page content.`;

        processedMessage = contextPrompt;
      }

      try {
        if (deepthink) {
          await performDeepThinking(processedMessage, message);
        } else {
          await performRegularResponse(processedMessage);
        }
      } catch (error) {
        console.error('API Error:', error);
        hideTypingIndicator();
        hideThinkingIndicator();
        addMessage(
          "I apologize, but I'm having trouble connecting to my AI service right now. Please try again in a moment.", 
          'ai', 
          true
        );
      }

      messageInput.focus();
    }

    async function performDeepThinking(processedMessage, originalMessage) {
      // Step 1: Show thinking indicator and perform chain-of-thought reasoning
      showThinkingIndicator();
      
      let webpageContext = '';
      let contextSummary = '';
      
      // Handle webpage context if available
      if (contextMode && sessionStorage.getItem("HTML4AI")) {
        const webpageData = processWebpageData(sessionStorage.getItem("HTML4AI"));
        
        // For deep thinking, process full content through chunking and summarization
        if (webpageData.content.length > 500) {
          // Show progress in thinking indicator
          updateThinkingIndicator('AI is processing webpage content');
          
          const chunks = chunkText(webpageData.content, 500);
          const summaries = [];
          
          // Process each chunk
          for (let i = 0; i < chunks.length; i++) {
            updateThinkingIndicator(`AI is processing chunk ${i + 1} of ${chunks.length}`);
            const summary = await summarizeChunk(chunks[i], i, chunks.length, webpageData.title);
            summaries.push(`Chunk ${i + 1} Summary: ${summary}`);
          }
          
          // Combine all summaries
          contextSummary = summaries.join('\n\n');
          webpageContext = `
<webpage_context>
Page Title: ${webpageData.title}
Full Content Summary (${chunks.length} chunks processed):

${contextSummary}
</webpage_context>`;
        } else {
          // Use content directly if it's under 500 characters
          webpageContext = `
<webpage_context>
Page Title: ${webpageData.title}
Content: ${webpageData.content}
</webpage_context>`;
        }
        
        updateThinkingIndicator('AI is thinking deeply about your question');
      }
      
      // Construct thinking prompt based on whether context mode is enabled
      let thinkingPrompt;
      if (contextMode && sessionStorage.getItem("HTML4AI")) {
        thinkingPrompt = `I have access to webpage content and need to think step by step about how to answer this question. Let me analyze the available information and plan my response.

${webpageContext}

Question: ${originalMessage}

Please think step by step:
1. What is the user asking for?
2. What information from the webpage is relevant to this question?
3. What additional knowledge do I need to provide?
4. How should I structure my response?
5. What key points should I emphasize?

Only return the reasoning - nothing else.

Please provide your detailed chain of thought reasoning:`;
      } else {
        thinkingPrompt = `Please think step by step about how to answer this question. Break down your reasoning process, consider different angles, and plan your response. Be thorough in your analysis.

Question: ${originalMessage}

Only return the reasoning - nothing else.

Please provide your chain of thought reasoning:`;
      }

      try {
        const thinkingResponse = await fetch(`${API_BASE_URL}${encodeURIComponent(thinkingPrompt)}`, {
          method: 'GET',
          headers: {
            'Accept': 'text/plain'
          }
        });
        
        if (!thinkingResponse.ok) {
          throw new Error(`HTTP error! status: ${thinkingResponse.status}`);
        }
        
        const thinkingText = await thinkingResponse.text();
        
        // Hide thinking indicator and show the thinking process
        hideThinkingIndicator();
        addThinkingMessage(thinkingText);
        
        // Step 2: Show typing indicator and get the final response
        showTypingIndicator();
        
        // Construct final prompt based on context availability
        let finalPrompt;
        if (contextMode && sessionStorage.getItem("HTML4AI")) {
          finalPrompt = `Based on the following reasoning and analysis, please provide a clear, concise, and helpful final answer to the user's question using the webpage context when relevant.

${webpageContext}

Previous reasoning:
${thinkingText}

Original question: ${originalMessage}

Instructions: Please provide your final response incorporating relevant information from the webpage context. When using information from the webpage, please indicate that you're referencing the provided page content.

Please provide your final response:`;
        } else {
          finalPrompt = `Based on the following reasoning and analysis, please provide a clear, concise, and helpful final answer to the user's question.

Previous reasoning:
${thinkingText}

Original question: ${originalMessage}

Please provide your final response:`;
        }

        const finalResponse = await fetch(`${API_BASE_URL}${encodeURIComponent(finalPrompt)}`, {
          method: 'GET',
          headers: {
            'Accept': 'text/plain'
          }
        });
        
        if (!finalResponse.ok) {
          throw new Error(`HTTP error! status: ${finalResponse.status}`);
        }
        
        const finalText = await finalResponse.text();
        
        hideTypingIndicator();
        addMessage(finalText, 'ai');
        
      } catch (error) {
        throw error; // Re-throw to be handled by the calling function
      }
    }

    async function performRegularResponse(processedMessage) {
      showTypingIndicator();
      
      // For regular responses (no deep thinking), limit context to 500 chars
      if (contextMode && sessionStorage.getItem("HTML4AI")) {
        const webpageData = processWebpageData(sessionStorage.getItem("HTML4AI"));
        
        // Limit content to 500 characters for regular responses
        const limitedContent = webpageData.content.length > 500 
          ? webpageData.content.substring(0, 500) + '...[content truncated]'
          : webpageData.content;
        
        const contextPrompt = `
<webpage_context>
Page Title: ${webpageData.title}
Content (limited): ${limitedContent}
</webpage_context>

User Question: ${processedMessage.split('User Question: ')[1] || processedMessage}

Instructions: You have access to the above webpage content (limited to 500 characters). Please answer the user's question using this context when relevant. If the question is not related to the webpage content, feel free to answer normally. When using information from the webpage, please indicate that you're referencing the provided page content.`;

        processedMessage = contextPrompt;
      }
      
      const response = await fetch(`${API_BASE_URL}${encodeURIComponent(processedMessage)}`, {
        method: 'GET',
        headers: {
          'Accept': 'text/plain'
        }
      });
      
      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }
      
      const aiResponse = await response.text();
      
      hideTypingIndicator();
      addMessage(aiResponse, 'ai');
    }

    function addMessage(content, sender, isError = false) {
      const chatMessages = document.getElementById('chatMessages');
      const messageDiv = document.createElement('div');
      messageDiv.className = `message ${sender}`;
      
      const now = new Date();
      const timeString = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
      
      const avatarIcon = sender === 'user' ? 'person' : 'auto_awesome';
      const bubbleClass = isError ? 'error-message' : 'message-bubble';
      
      messageDiv.innerHTML = `
        <div class="message-avatar">
          <span class="material-symbols-outlined">${avatarIcon}</span>
        </div>
        <div class="${bubbleClass}">
          ${formatMessage(content)}
          <div class="message-time">${timeString}</div>
        </div>
      `;
      
      chatMessages.appendChild(messageDiv);
      scrollToBottom();
      
      // Add to chat history
      chatHistory.push({
        content: content,
        sender: sender,
        timestamp: now.toISOString(),
        isError: isError
      });
    }

    function addThinkingMessage(content) {
      const chatMessages = document.getElementById('chatMessages');
      const messageDiv = document.createElement('div');
      messageDiv.className = 'message thinking';
      
      const now = new Date();
      const timeString = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
      
      messageDiv.innerHTML = `
        <div class="message-avatar">
          <span class="material-symbols-outlined">psychology</span>
        </div>
        <div class="message-bubble">
          <div class="thinking-header">
            <span class="material-symbols-outlined">lightbulb</span>
            <span>Chain of Thought</span>
          </div>
          <div class="thinking-content">
            ${formatMessage(content)}
          </div>
          <div class="message-time">${timeString}</div>
        </div>
      `;
      
      chatMessages.appendChild(messageDiv);
      scrollToBottom();
      
      // Add to chat history
      chatHistory.push({
        content: content,
        sender: 'thinking',
        timestamp: now.toISOString(),
        isError: false
      });
    }

    function formatMessage(content) {
      // Basic text formatting with better handling of code blocks
      return content
        .replace(/\n/g, '<br>')
        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
        .replace(/\*(.*?)\*/g, '<em>$1</em>')
        .replace(/`(.*?)`/g, '<code style="background: rgba(255,255,255,0.1); padding: 2px 4px; border-radius: 4px; font-family: monospace;">$1</code>');
    }

    function showTypingIndicator() {
      isTyping = true;
      const chatMessages = document.getElementById('chatMessages');
      const typingDiv = document.createElement('div');
      typingDiv.id = 'typingIndicator';
      typingDiv.className = 'message ai';
      
      typingDiv.innerHTML = `
        <div class="message-avatar">
          <span class="material-symbols-outlined">auto_awesome</span>
        </div>
        <div class="typing-indicator">
          <span>AI is responding</span>
          <div class="typing-dots">
            <div class="typing-dot"></div>
            <div class="typing-dot"></div>
            <div class="typing-dot"></div>
          </div>
        </div>
      `;
      
      chatMessages.appendChild(typingDiv);
      scrollToBottom();
    }

    function hideTypingIndicator() {
      isTyping = false;
      const typingIndicator = document.getElementById('typingIndicator');
      if (typingIndicator) {
        typingIndicator.remove();
      }
    }

    function showThinkingIndicator() {
      const chatMessages = document.getElementById('chatMessages');
      const thinkingDiv = document.createElement('div');
      thinkingDiv.id = 'thinkingIndicator';
      thinkingDiv.className = 'message thinking';
      
      thinkingDiv.innerHTML = `
        <div class="message-avatar">
          <span class="material-symbols-outlined">psychology</span>
        </div>
        <div class="thinking-indicator">
          <span>AI is thinking deeply</span>
          <div class="thinking-dots">
            <div class="thinking-dot"></div>
            <div class="thinking-dot"></div>
            <div class="thinking-dot"></div>
          </div>
        </div>
      `;
      
      chatMessages.appendChild(thinkingDiv);
      scrollToBottom();
    }

    function hideThinkingIndicator() {
      const thinkingIndicator = document.getElementById('thinkingIndicator');
      if (thinkingIndicator) {
        thinkingIndicator.remove();
      }
    }

    function hideWelcomeMessage() {
      const welcomeMessage = document.getElementById('welcomeMessage');
      if (welcomeMessage) {
        welcomeMessage.style.display = 'none';
      }
    }

    function scrollToBottom() {
      const chatMessages = document.getElementById('chatMessages');
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    function clearChat() {
      if (confirm('Are you sure you want to clear the chat history?')) {
        const chatMessages = document.getElementById('chatMessages');
        chatMessages.innerHTML = `
          <div class="welcome-message" id="welcomeMessage">
            <div class="material-symbols-outlined ai-icon">auto_awesome</div>
            <div class="welcome-title">Welcome to Axiom AI</div>
            <div class="welcome-subtitle">
              Your intelligent conversation partner powered by advanced AI. I can help with questions, analysis, and even work with webpage content.
            </div>

          </div>
        `;
        
        chatHistory = [];
      }
    }

    // Keyboard shortcuts
    document.addEventListener('keydown', function(e) {
      // Escape to focus input
      if (e.key === 'Escape') {
        document.getElementById('messageInput').focus();
      }
      
      // Ctrl/Cmd + K to clear chat
      if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
        e.preventDefault();
        clearChat();
      }
      
      // Ctrl/Cmd + / to toggle context mode
      if ((e.ctrlKey || e.metaKey) && e.key === '/') {
        e.preventDefault();
        toggleContextMode();
      }

      // Ctrl/Cmd + T to toggle deep thinking mode
      if ((e.ctrlKey || e.metaKey) && e.key === 't') {
        e.preventDefault();
        toggleDeepThink();
      }
    });

    // Handle window focus for better UX
    window.addEventListener('focus', function() {
      document.getElementById('messageInput').focus();
      checkWebpageContext();
    });

    // Handle paste events for better UX
    document.getElementById('messageInput').addEventListener('paste', function(e) {
      // Allow default paste behavior, but trigger resize
      setTimeout(() => {
        this.style.height = 'auto';
        this.style.height = Math.min(this.scrollHeight, 120) + 'px';
        document.getElementById('sendBtn').disabled = !this.value.trim();
      }, 10);
    });

    // Prevent form submission on Enter in input
    document.getElementById('messageInput').addEventListener('keypress', function(e) {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
      }
    });

    // Handle window resize for mobile responsiveness
    window.addEventListener('resize', function() {
      scrollToBottom();
    });

    // Storage event listener for cross-tab webpage context updates
    window.addEventListener('storage', function(e) {
      if (e.key === 'HTML4AI') {
        checkWebpageContext();
      }
    });
  </script>
</body>
</html>