<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, shrink-to-fit=no">
  <title>Axiom - New Tab</title>
  <meta name="googlebot" content="index, follow, snippet">
  <link rel="shortcut icon" href="favicon.ico">
  <link rel="icon" type="image/png" href="assets/favicon.png">
  <link rel="stylesheet" href="scripts/css/global.css">
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght@250" rel="stylesheet">
  <script src="uv/uv.bundle.js" defer></script>
  <script src="uv/uv.config.js" defer></script>
  <style>
    :root {
      /* Modern Color Palette */
      --color-primary: #6366f1;
      --color-secondary: #8b5cf6;
      --color-accent: #06b6d4;
      --color-success: #10b981;
      --color-warning: #f59e0b;
      --color-danger: #ef4444;

      /* Background & Surfaces */
      --color-background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #334155 100%);
      --color-surface: rgba(255, 255, 255, 0.08);
      --color-surface-hover: rgba(255, 255, 255, 0.12);
      --color-surface-active: rgba(255, 255, 255, 0.16);

      /* Text Colors */
      --color-text-primary: #f8fafc;
      --color-text-secondary: #cbd5e1;
      --color-text-muted: #94a3b8;

      /* Glassmorphism Effects */
      --glass-background: rgba(255, 255, 255, 0.1);
      --glass-border: rgba(255, 255, 255, 0.2);
      --glass-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
      --glass-blur: blur(16px);

      /* Spacing & Dimensions */
      --toolbar-height: 48px;
      --border-radius: 12px;
      --border-radius-lg: 16px;
      --spacing-xs: 4px;
      --spacing-sm: 6px;
      --spacing-md: 12px;
      --spacing-lg: 16px;
      --spacing-xl: 24px;

      /* Transitions */
      --transition-fast: 0.15s cubic-bezier(0.4, 0, 0.2, 1);
      --transition-normal: 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      --transition-slow: 0.5s cubic-bezier(0.4, 0, 0.2, 1);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      color: var(--color-text-primary);
      font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      overflow: hidden;
      position: relative;
      min-height: 100vh;
    }

    /* Animated Background */
    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background:
        radial-gradient(circle at 20% 50%, rgba(120, 119, 198, 0.3) 0%, transparent 50%),
        radial-gradient(circle at 80% 20%, rgba(255, 119, 198, 0.3) 0%, transparent 50%),
        radial-gradient(circle at 40% 80%, rgba(120, 219, 255, 0.3) 0%, transparent 50%);
      z-index: -1;
      animation: backgroundShift 20s ease-in-out infinite;
    }

    @keyframes backgroundShift {

      0%,
      100% {
        opacity: 1;
      }

      50% {
        opacity: 0.7;
      }
    }

    /* Modern Toolbar - Made Thinner */
    #searchbar {
      backdrop-filter: var(--glass-blur);
      width: 100%;
      height: var(--toolbar-height);
      position: fixed;
      top: 0;
      z-index: 1000;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0 var(--spacing-md);
      box-shadow: var(--glass-shadow);
      transition: all var(--transition-normal);
      gap: var(--spacing-sm);
    }

    #searchbar:hover {
      background: var(--color-surface-hover);
    }

    /* Navigation Controls */
    .nav-controls {
      display: flex;
      align-items: center;
      gap: var(--spacing-xs);
    }

    .toolbar-controls {
      display: flex;
      align-items: center;
      gap: var(--spacing-xs);
    }

    /* Search Input Container */
    .search-container {
      display: flex;
      align-items: center;
      flex: 1;
      max-width: 600px;
      position: relative;
    }

    #search {
      background: var(--glass-background);
      border: 2px solid var(--glass-border);
      border-radius: var(--border-radius-lg);
      color: var(--color-text-primary);
      font-size: 14px;
      padding: var(--spacing-sm) var(--spacing-md);
      width: 100%;
      outline: none;
      backdrop-filter: var(--glass-blur);
      transition: all var(--transition-normal);
      font-weight: 400;
    }

    #search::placeholder {
      color: var(--color-text-muted);
    }

    #search:focus {
      border-color: var(--color-primary);
      background: var(--color-surface-hover);
      box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
      transform: scale(1.01);
    }

    /* Action Buttons - Made Smaller */
    .action-btn {
      background: var(--glass-background);
      border: 1px solid var(--glass-border);
      border-radius: var(--border-radius);
      color: var(--color-text-secondary);
      cursor: pointer;
      padding: var(--spacing-xs);
      margin: 0 var(--spacing-xs);
      transition: all var(--transition-fast);
      backdrop-filter: var(--glass-blur);
      display: flex;
      align-items: center;
      justify-content: center;
      width: 36px;
      height: 36px;
      font-size: 18px;
    }

    .action-btn:hover {
      background: var(--color-surface-hover);
      border-color: var(--color-primary);
      color: var(--color-text-primary);
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }

    .action-btn:active {
      transform: translateY(0);
      background: var(--color-surface-active);
    }

    .action-btn.refresh:hover {
      border-color: var(--color-success);
      color: var(--color-success);
    }

    .action-btn.search:hover {
      border-color: var(--color-primary);
      color: var(--color-primary);
    }

    .action-btn.terminal:hover {
      border-color: var(--color-warning);
      color: var(--color-warning);
    }

    .action-btn.nav:hover {
      border-color: var(--color-accent);
      color: var(--color-accent);
    }

    .action-btn.fullscreen:hover {
      border-color: var(--color-accent);
      color: var(--color-accent);
    }

    .action-btn.settings:hover {
      border-color: var(--color-secondary);
      color: var(--color-secondary);
    }

    /* Search Engine Indicator */
    .search-engine-indicator {
      position: absolute;
      display: none;
      right: 12px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 11px;
      color: var(--color-text-muted);
      background: rgba(0, 0, 0, 0.3);
      padding: 2px 6px;
      border-radius: 4px;
      backdrop-filter: blur(8px);
      transition: all var(--transition-fast);
      pointer-events: none;
    }

    #search:focus+.search-engine-indicator {
      opacity: 0.7;
      transform: translateY(-50%) scale(0.9);
    }

    /* Bridge Selector - Made Smaller */
    .bridge-selector {
      background: var(--glass-background);
      border: 1px solid var(--glass-border);
      border-radius: var(--border-radius);
      padding: var(--spacing-xs) var(--spacing-sm);
      display: flex;
      align-items: center;
      gap: var(--spacing-xs);
      backdrop-filter: var(--glass-blur);
      transition: all var(--transition-normal);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
      position: relative;
      overflow: hidden;
    }

    .bridge-selector::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
      transition: left var(--transition-slow);
    }

    .bridge-selector:hover::before {
      left: 100%;
    }

    .bridge-selector:hover {
      background: var(--color-surface-hover);
      border-color: var(--color-primary);
      transform: translateY(-1px);
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.3);
    }

    .bridge-icon {
      font-size: 16px;
      color: var(--color-text-muted);
      transition: color var(--transition-fast);
    }

    .bridge-selector:hover .bridge-icon {
      color: var(--color-primary);
    }

    .custom-select {
      position: relative;
      display: flex;
      align-items: center;
      gap: var(--spacing-xs);
    }

    #bridge-select {
      background: transparent;
      border: none;
      color: var(--color-text-primary);
      font-size: 12px;
      font-weight: 500;
      outline: none;
      cursor: pointer;
      padding: var(--spacing-xs) 0;
      min-width: 80px;
      appearance: none;
      -webkit-appearance: none;
      -moz-appearance: none;
    }

    #bridge-select option {
      background: #1e293b;
      color: var(--color-text-primary);
      padding: var(--spacing-sm);
      border-radius: var(--border-radius);
    }

    .select-arrow {
      font-size: 14px;
      color: var(--color-text-muted);
      transition: all var(--transition-fast);
      pointer-events: none;
    }

    /* Bridge Selector Active State */
    .bridge-selector.active {
      border-color: var(--color-success);
      box-shadow: 0 2px 8px rgba(16, 185, 129, 0.3);
    }

    .bridge-selector.active .bridge-icon,
    .bridge-selector.active .select-arrow {
      color: var(--color-success);
    }

    .bridge-selector.active::after {
      content: '';
      position: absolute;
      top: -2px;
      left: -2px;
      right: -2px;
      bottom: -2px;
      background: linear-gradient(45deg, var(--color-success), transparent, var(--color-success));
      border-radius: var(--border-radius);
      z-index: -1;
      opacity: 0.3;
      animation: activeGlow 2s ease-in-out infinite alternate;
    }

    @keyframes activeGlow {
      from {
        opacity: 0.2;
      }

      to {
        opacity: 0.4;
      }
    }

    /* Iframe Container */
    #frames {
      width: 100%;
      height: calc(100vh - var(--toolbar-height));
      position: fixed;
      background-color: white;
      top: var(--toolbar-height);
      border: none;
      left: 0;
      box-sizing: border-box;
    }

    #uv-frame {
      width: 100%;
      height: 100%;

      border: none;
      background: var(--color-surface);
      box-shadow: var(--glass-shadow);
    }

    /* Search Suggestions */
    .resultBox {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: var(--glass-background);
      border: 1px solid var(--glass-border);
      border-radius: 0 0 var(--border-radius-lg) var(--border-radius-lg);
      backdrop-filter: var(--glass-blur);
      box-shadow: var(--glass-shadow);
      max-height: 300px;
      overflow-y: auto;
      z-index: 1001;
      list-style: none;
      margin-top: var(--spacing-xs);
    }

    .resultBox li {
      padding: var(--spacing-sm) var(--spacing-md);
      color: var(--color-text-secondary);
      cursor: pointer;
      transition: all var(--transition-fast);
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
      font-size: 13px;
    }

    .resultBox li:last-child {
      border-bottom: none;
    }

    .resultBox li:hover {
      background: var(--color-surface-hover);
      color: var(--color-text-primary);
      transform: translateX(4px);
    }

    /* Loader Animation */
    .loader {
      width: 24px;
      height: 24px;
      border: 2px solid transparent;
      border-top: 2px solid var(--color-primary);
      border-radius: 50%;
      animation: loaderSpin 1s linear infinite;
      margin: 0 var(--spacing-sm);
    }

    @keyframes loaderSpin {
      0% {
        transform: rotate(0deg);
      }

      100% {
        transform: rotate(360deg);
      }
    }

    /* Responsive Design */
    @media (max-width: 768px) {
      #searchbar {
        flex-direction: column;
        height: auto;
        min-height: 56px;
        padding: var(--spacing-sm);
        gap: var(--spacing-xs);
      }

      .nav-controls,
      .toolbar-controls {
        order: 2;
      }

      .search-container {
        order: 1;
        width: 100%;
        max-width: none;
      }

      #frames {
        height: calc(100vh - 56px);
        top: 56px;
        padding: var(--spacing-sm);
      }
    }

    @media (max-width: 640px) {
      .bridge-selector {
        display: none;
      }

      .nav-controls {
        gap: var(--spacing-xs);
      }

      .action-btn {
        width: 32px;
        height: 32px;
        font-size: 16px;
      }
    }

    /* Custom Scrollbar */
    .resultBox::-webkit-scrollbar {
      width: 6px;
    }

    .resultBox::-webkit-scrollbar-track {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 3px;
    }

    .resultBox::-webkit-scrollbar-thumb {
      background: var(--color-primary);
      border-radius: 3px;
    }

    .resultBox::-webkit-scrollbar-thumb:hover {
      background: var(--color-secondary);
    }

    /* Focus States for Accessibility */
    .action-btn:focus,
    #search:focus {
      outline: 2px solid var(--color-primary);
      outline-offset: 2px;
    }

    /* Micro Animations */
    @keyframes pulse {

      0%,
      100% {
        opacity: 1;
      }

      50% {
        opacity: 0.7;
      }
    }

    .loading {
      animation: pulse 2s ease-in-out infinite;
    }

    /* Hidden Elements */
    #uv-form {
      display: none;
    }
  </style>
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-278K4F012J"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag() { dataLayer.push(arguments); }
    gtag('js', new Date());
    gtag('config', 'G-278K4F012J');
  </script>
</head>

<body>
  <div id="searchbar">
    <div class="nav-controls">
      <span onclick="goBack()" class="material-symbols-outlined action-btn nav" title="Go Back">arrow_back</span>
      <span onclick="goForward()" class="material-symbols-outlined action-btn nav"
        title="Go Forward">arrow_forward</span>
      <span id="refresh" onclick="location.reload()" class="material-symbols-outlined action-btn refresh"
        title="Refresh Page">refresh</span>
    </div>

    <div class="search-container">
      <input id="search" oninput="search()" placeholder="Search or enter a URL..." type="search" />
      <span class="search-engine-indicator" id="search-indicator">Brave</span>
    </div>

    <div class="toolbar-controls">
      <span onclick="navigateToPage()" class="material-symbols-outlined action-btn search"
        title="Navigate">search</span>
      <span onclick="handle_eruda()" class="material-symbols-outlined action-btn terminal"
        title="Developer Tools">terminal</span>
      <span onclick="handle_fullscreen()" class="material-symbols-outlined action-btn fullscreen"
        title="Fullscreen Mode">fullscreen</span>
      <span onclick="openSettings()" class="material-symbols-outlined action-btn settings"
        title="Settings">settings</span>

      <div class="bridge-selector" title="Select proxy bridge">
        <span class="material-symbols-outlined bridge-icon">vpn_key</span>
        <div class="custom-select">
          <select id="bridge-select" onchange="handleBridgeChange()">
            <option value="None">Direct</option>
            <option value="12FT">12ft.io</option>
            <option value="Archive.org/Wayback Machine">Archive.org</option>
            <option value="Google Cache">Google Cache</option>
          </select>
          <span class="material-symbols-outlined select-arrow">keyboard_arrow_down</span>
        </div>
      </div>
    </div>
  </div>

  <div id="frames">
    <form id="uv-form" class="flex-center">
      <input id="uv-search-engine" value="https://www.google.com/search?q=%s" type="hidden">
      <input id="uv-address" type="hidden">
    </form>
    <iframe id="uv-frame"></iframe>
  </div>

  <script>
    // Enhanced Search Engine Management
    const SEARCH_ENGINES = {
      brave: {
        name: "Brave",
        url: "https://search.brave.com/search?q=",
        color: "#fb542b"
      },
      duckduckgo: {
        name: "DuckDuckGo",
        url: "https://duckduckgo.com/?q=",
        color: "#de5833"
      },
      google: {
        name: "Google",
        url: "https://www.google.com/search?q=",
        color: "#4285f4"
      },
      bing: {
        name: "Bing",
        url: "https://www.bing.com/search?q=",
        color: "#008ad7"
      },
      startpage: {
        name: "Startpage",
        url: "https://www.startpage.com/sp/search?q=",
        color: "#1a73e8"
      },
      yandex: {
        name: "Yandex",
        url: "https://yandex.com/search/?text=",
        color: "#fc3f1d"
      },
      searx: {
        name: "SearX",
        url: "https://searx.org/?q=",
        color: "#3050ff"
      }
    };

    // Global state variables
    let currentSearchEngine = localStorage.getItem("searchEnginePreference") || "brave";
    let search_engine = SEARCH_ENGINES[currentSearchEngine]?.url || SEARCH_ENGINES.brave.url;
    const proxy_bridge = localStorage.getItem("proxy") || "None";
    let suggestions = [];
    let typing = 0;
    let current_summary = "";
    let serviceWorkerRegistered = false;

    // Performance optimizations
    let lastUpdateTime = 0;
    let updateFrameId = null;
    let lastIframeCheck = 0;
    const IFRAME_CHECK_INTERVAL = 2000; // Reduced from 500ms to 2s
    const TITLE_UPDATE_INTERVAL = 1000; // Reduced from 500ms to 1s

    // Debounce function for expensive operations
    function debounce(func, wait) {
      let timeout;
      return function executedFunction(...args) {
        const later = () => {
          clearTimeout(timeout);
          func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
      };
    }

    // Throttle function for frequent operations
    function throttle(func, limit) {
      let inThrottle;
      return function (...args) {
        if (!inThrottle) {
          func.apply(this, args);
          inThrottle = true;
          setTimeout(() => inThrottle = false, limit);
        }
      }
    }

    // Register service worker only once
    async function registerServiceWorker() {
      if (serviceWorkerRegistered || !('serviceWorker' in navigator)) {
        return;
      }

      try {
        await navigator.serviceWorker.register('sw.js');
        serviceWorkerRegistered = true;
        console.log("Service worker registered successfully");
      } catch (err) {
        console.warn("Failed to register service worker:", err);
      }
    }

    // Initialize search engine and update UI
    function initializeSearchEngine() {
      updateSearchEngineIndicator();
      updateSearchPlaceholder();
    }

    // Update the search engine indicator
    function updateSearchEngineIndicator() {
      const indicator = document.getElementById("search-indicator");
      const engine = SEARCH_ENGINES[currentSearchEngine];

      if (indicator && engine) {
        indicator.textContent = engine.name;
        indicator.style.color = engine.color;
      }
    }

    // Update search placeholder text
    function updateSearchPlaceholder() {
      const searchInput = document.getElementById("search");
      const engine = SEARCH_ENGINES[currentSearchEngine];

      if (searchInput && engine) {
        searchInput.placeholder = `Search with ${engine.name} or enter a URL...`;
      }
    }

    // Listen for storage changes (when settings are updated)
    window.addEventListener('storage', function (e) {
      if (e.key === 'searchEnginePreference' && e.newValue) {
        currentSearchEngine = e.newValue;
        search_engine = SEARCH_ENGINES[currentSearchEngine]?.url || SEARCH_ENGINES.brave.url;
        initializeSearchEngine();
        console.log(`Search engine changed to: ${SEARCH_ENGINES[currentSearchEngine]?.name}`);
      }
    });

    // Function to open settings page
    function openSettings() {
      window.open('settings.html', '_blank');
    }

    // Set initial bridge selection
    function initializeBridgeSelector() {
      const bridgeSelect = document.getElementById("bridge-select");
      const bridgeSelector = document.querySelector(".bridge-selector");

      if (bridgeSelect && bridgeSelector) {
        bridgeSelect.value = proxy_bridge;
        updateBridgeStatus();
      }
    }

    function updateBridgeStatus() {
      const bridgeSelect = document.getElementById("bridge-select");
      const bridgeSelector = document.querySelector(".bridge-selector");
      const selectedBridge = bridgeSelect.value;

      // Add or remove active class based on bridge selection
      if (selectedBridge && selectedBridge !== "None") {
        bridgeSelector.classList.add("active");
      } else {
        bridgeSelector.classList.remove("active");
      }
    }

    function handleBridgeChange() {
      const bridgeSelect = document.getElementById("bridge-select");
      const bridgeSelector = document.querySelector(".bridge-selector");
      const selectedBridge = bridgeSelect.value;

      // Save to localStorage
      localStorage.setItem("proxy", selectedBridge);

      // Update visual status
      updateBridgeStatus();

      // Show brief feedback flash
      bridgeSelector.style.transform = "scale(1.05)";
      setTimeout(() => {
        bridgeSelector.style.transform = "";
      }, 200);

      // Reload the frame with the new bridge
      reloadFrameWithBridge();
    }

    async function reloadFrameWithBridge() {
      const address = document.getElementById("uv-address");
      const currentUrl = address.value;

      if (currentUrl) {
        try {
          const domains = await fetchGlitchDomains();
          let url = buildSearchUrl(currentUrl, search_engine, domains);
          url = applyBridge(url);

          console.log("Reloading with new bridge:", url);

          const frame = document.getElementById("uv-frame");
          frame.src = `${__uv$config.prefix}${__uv$config.encodeUrl(url)}`;
        } catch (error) {
          console.error("Error reloading frame with bridge:", error);
        }
      }
    }

    // Initialize everything on page load
    function initializePage() {
      // Load search engine preference
      const savedEngine = localStorage.getItem("searchEnginePreference");
      if (savedEngine && SEARCH_ENGINES[savedEngine]) {
        currentSearchEngine = savedEngine;
        search_engine = SEARCH_ENGINES[currentSearchEngine].url;
      }

      initializeSearchEngine();
      initializeBridgeSelector();
    }

    // Navigation functions
    function goBack() {
      const frame = document.getElementById("uv-frame");
      if (frame && frame.contentWindow) {
        try {
          frame.contentWindow.history.back();
        } catch (e) {
          console.log("Cannot navigate back:", e);
        }
      }
    }

    function goForward() {
      const frame = document.getElementById("uv-frame");
      if (frame && frame.contentWindow) {
        try {
          frame.contentWindow.history.forward();
        } catch (e) {
          console.log("Cannot navigate forward:", e);
        }
      }
    }

    function getURLParameter(name) {
      const regex = new RegExp(`[\\?&]${name}=([^&#]*)`);
      const results = regex.exec(location.search);
      return results ? decodeURIComponent(results[1].replace(/\+/g, ' ')) : '';
    }

    // Event listeners
    document.addEventListener("DOMContentLoaded", async () => {
      const searchInput = document.getElementById("search");

      // Focus event listeners with better performance
      searchInput.addEventListener("focusin", () => typing = 1);
      searchInput.addEventListener("focusout", () => {
        typing = 0;
        // Clear suggestions when losing focus
        setTimeout(() => {
          const resultBox = document.querySelector(".resultBox");
          if (resultBox) resultBox.innerHTML = "";
        }, 150);
      });

      // Keydown listener for Enter key
      searchInput.addEventListener("keydown", function (event) {
        if (event.key === "Enter") {
          navigateToPage();
        }
      });

      initializePage();

      await registerServiceWorker();
      
      if (localStorage.getItem("lifetime_visit") != null){
        localStorage.setItem("lifetime_visit", parseInt(localStorage.getItem("lifetime_visit")) + 1); 
      }
      else{
        localStorage.setItem("lifetime_visit", 1);
      } // TODO: make this not just count for launch_page.html visits - make it count for page changes in the frame

      let urlParam = getURLParameter("url"); // btoa cause i guess we are doing that now
      try {
        urlParam = atob(urlParam);
        // check for non acsii characters
        for (let i = 0; i < urlParam.length; i++) {
          if (urlParam.charCodeAt(i) > 127) {
            // non-ascii character found
            throw new Error("Invalid URL parameter"); // triger catch
          }
        }
      }
      catch{} // at least we know its not base64

      if (urlParam) {
        const address = document.getElementById("uv-address");
        address.value = urlParam;

        try {
          const domains = await fetchGlitchDomains();
          let url = buildSearchUrl(address.value, search_engine, domains);
          url = applyBridge(url);

          console.log("Final URL:", url);

          const frame = document.getElementById("uv-frame");
          frame.src = `${__uv$config.prefix}${__uv$config.encodeUrl(url)}`;
          frame.style.display = "block";
        } catch (error) {
          console.error("Error initializing frame:", error);
        }
      }

      // Update bridge status after initialization
      setTimeout(updateBridgeStatus, 100);

      // Start optimized monitoring loops
      startOptimizedMonitoring();
    });

    function navigateToPage() {
      const url = document.getElementById('search').value;
      window.location = `launch_page.html?url=${btoa(url)}`;
    }

    // Optimized iframe monitoring with better performance
    function startOptimizedMonitoring() {
      const frame = document.getElementById("uv-frame");

      // Optimized title update function
      const updateDocumentTitle = throttle(() => {
        try {
          if (frame.contentDocument) {
            const frameTitle = frame.contentDocument.title;
            if (frameTitle && document.title !== frameTitle) {
              document.title = frameTitle + "|G|" + document.getElementById('search').value;
            }
          }
        } catch (e) {
          // Silently handle cross-origin errors
        }
      }, TITLE_UPDATE_INTERVAL);

      // Optimized iframe content monitoring
      const updateIframeContent = throttle(() => {
        if (typing) return; // Don't update while user is typing

        try {
          // Update search bar URL
          const currentHref = frame.contentWindow.location.href;
          if (currentHref && currentHref.includes("/assets-images/")) {
            const decodedUrl = __uv$config.decodeUrl(currentHref.split("/assets-images/")[1]);
            const searchInput = document.getElementById("search");

            if (decodedUrl && decodedUrl !== searchInput.value) {
              searchInput.value = decodedUrl;
            }
          }

          // Update AI content summary (less frequently)
          const now = Date.now();
          if (now - lastIframeCheck > IFRAME_CHECK_INTERVAL) {
            lastIframeCheck = now;

            if (frame.contentDocument && frame.contentDocument.body) {

              let iframeHTML = frame.contentDocument.body.innerHTML || "";
              const h1Index = iframeHTML.indexOf("<h1");
              if (h1Index !== -1) {
                iframeHTML = iframeHTML.substring(h1Index);
              }

              iframeHTML = iframeHTML.replace(/<script[^>]*>[\s\S]*?<\/script>/gi, '');
              iframeHTML = iframeHTML.replace(/<style[^>]*>[\s\S]*?<\/style>/gi, '');
              iframeHTML = iframeHTML.replace(/(\n\s*\n)|\n\s+|\n{2,}/g, '\n').trim();
              iframeHTML = iframeHTML.replace(/[\\\/]\n|\t|\n|\r/g, ' ');
              iframeHTML = iframeHTML.replace(/\s{2,}/g, ' ');
              iframeHTML = iframeHTML.replace(/<[^>]*>/g, "");

              // cut if too long
              if (iframeHTML.length > 3000) {
                iframeHTML = iframeHTML.substring(0, 3000) + '\n\n[Content truncated due to length...]';
              }
              if (iframeHTML !== current_summary) {
                sessionStorage.setItem('HTML4AI', iframeHTML);
                current_summary = iframeHTML;
              }
            }
          }
        } catch (e) {
          // Silently handle cross-origin errors
        }
      }, 1000); // Increased from 500ms to 1000ms

      // Frame load event listener
      frame.addEventListener('load', () => {
        updateDocumentTitle();
        updateIframeContent();
      });

      // Use requestAnimationFrame for smooth updates
      function animationLoop() {
        updateDocumentTitle();
        updateIframeContent();
        requestAnimationFrame(animationLoop);
      }

      // Start the animation loop only after frame is loaded
      if (frame.src) {
        requestAnimationFrame(animationLoop);
      }
    }

    // Optimized search suggestions with debouncing
    const searchInput = document.querySelector("#search");
    const resultBox = document.createElement("ul");
    resultBox.classList.add("resultBox");
    searchInput.parentNode.appendChild(resultBox);

    // Debounced search function
    const debouncedSearch = debounce(async (userData) => {
      if (!userData.trim()) {
        resultBox.innerHTML = "";
        return;
      }

      try {
        const response = await fetch(`/search_complete/${encodeURIComponent(userData)}`);
        const jsonData = await response.json();
        suggestions = jsonData[1] || [];
        showSuggestions(suggestions);
      } catch (err) {
        console.log("Search suggestions error:", err);
        suggestions = [];
        showSuggestions([]);
      }
    }, 300); // Debounce search requests

    searchInput.addEventListener('input', (e) => {
      debouncedSearch(e.target.value);
    });

    function showSuggestions(list) {
      const engineName = SEARCH_ENGINES[currentSearchEngine]?.name || "Search";
      resultBox.innerHTML = list.slice(0, 8).map(data => // Limit to 8 suggestions
        `<li onclick="window.location='launch.html?url=${encodeURIComponent(search_engine + data)}'">${data} - <span style='filter: opacity(0.4);'>${engineName}</span></li>`
      ).join('');
    }

    function buildSearchUrl(input, searchEngine, domains) {
      let url;
      try {
        if (!input.startsWith("http://") && !input.startsWith("https://") && input.includes(".")) {
          input = "https://" + input;
        }
        url = new URL(input).toString();
      } catch (err) {
        return `${searchEngine}${encodeURIComponent(input)}`;
      }

      for (const domain of domains) {
        if (url.includes(domain.split("|")[0])) {
          url = domain.split("|")[1];
          break;
        }
      }

      return url;
    }

    function applyBridge(url) {
      const currentBridge = localStorage.getItem("proxy") || "None";
      if (currentBridge && currentBridge !== "None") {
        const bridgeUrl = getProxyBridge(currentBridge);
        if (bridgeUrl) {
          return `${bridgeUrl}${encodeURIComponent(url)}`;
        }
      }
      return url;
    }

    function getProxyBridge(proxyBridge) {
      switch (proxyBridge) {
        case "12FT":
          return "https://12ft.io/";
        case "Archive.org/Wayback Machine":
          return "https://web.archive.org/";
        case "Google Cache":
          return "https://webcache.googleusercontent.com/search?q=cache:";
        default:
          return "";
      }
    }

    let eruda_status = 0;

    function handle_eruda() {
      if (typeof window.eruda === 'undefined') {
        const script = document.createElement('script');
        script.src = "https://cdn.jsdelivr.net/npm/eruda";
        document.body.append(script);
        script.onload = function () {
          eruda.init();
          eruda.show();
        };
      } else {
        if (eruda_status === 0) {
          window.eruda.show();
          eruda_status = 1;
        } else {
          window.eruda.hide();
          eruda_status = 0;
        }
      }
    }

    function handle_fullscreen() {
      if (!document.fullscreenElement) {
        document.documentElement.requestFullscreen().catch(err => {
          console.log(`Error attempting to enable fullscreen: ${err.message}`);
        });
      } else {
        if (document.exitFullscreen) {
          document.exitFullscreen();
        }
      }
    }

    // Cached domains with expiration
    let cachedDomains = null;
    let cacheExpiry = 0;
    const CACHE_DURATION = 5 * 60 * 1000; // 5 minutes

    async function fetchGlitchDomains() {
      return [] // fuck you
    }
  </script>
  <script src="global.js"></script>
</body>

</html>